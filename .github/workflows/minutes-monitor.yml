name: Monitor GitHub Minutes Usage

# Runs daily to track minutes and alert when running low

on:
  schedule:
    - cron: '0 9 * * *'  # Daily at 9 AM UTC
  workflow_dispatch:

jobs:
  check-usage:
    runs-on: ubuntu-latest

    steps:
      - name: Check minutes usage
        id: check
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            let used = 0, included = 2000, remaining = 2000;

            try {
              const { data } = await github.rest.billing.getGithubActionsBillingUser({
                username: owner
              });
              used = data.total_minutes_used;
              included = data.included_minutes;
              remaining = included - used;
            } catch (e) {
              console.log('Could not fetch billing info');
            }

            const percentage = Math.round((used / included) * 100);

            core.setOutput('used', used);
            core.setOutput('included', included);
            core.setOutput('remaining', remaining);
            core.setOutput('percentage', percentage);

            // Create summary
            let status = 'ðŸŸ¢';
            if (percentage > 90) status = 'ðŸ”´';
            else if (percentage > 75) status = 'ðŸŸ¡';

            const summary = `
            ## GitHub Actions Minutes Report ${status}

            | Metric | Value |
            |--------|-------|
            | Used | ${used} min |
            | Included | ${included} min |
            | Remaining | ${remaining} min |
            | Usage | ${percentage}% |

            ${percentage > 75 ? 'âš ï¸ **Consider switching to self-hosted runner**' : ''}
            ${percentage > 90 ? 'ðŸš¨ **Running low! Self-hosted runner recommended**' : ''}
            `;

            core.summary.addRaw(summary);
            await core.summary.write();

            return { used, remaining, percentage };

      - name: Alert if running low
        if: steps.check.outputs.percentage > 75
        run: |
          echo "::warning::GitHub Actions minutes at ${{ steps.check.outputs.percentage }}% (${{ steps.check.outputs.remaining }} remaining)"
